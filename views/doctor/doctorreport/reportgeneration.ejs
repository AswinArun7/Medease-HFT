<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medico-Legal Teleconsultation Record</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />

    <!-- Styles -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .form-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            margin-bottom: 30px;
        }

        .form-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        .group {
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
        }

        .group.wide {
            grid-column: 1 / -1;
        }

        .group h3 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-wrapper {
            margin-bottom: 20px;
        }

        .input-wrapper label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .input-wrapper input[type="text"],
        .input-wrapper input[type="datetime-local"],
        .input-wrapper select,
        .input-wrapper textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .input-wrapper textarea {
            min-height: 100px;
            resize: vertical;
        }

        .row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .file-box {
            position: relative;
            border: 2px dashed #ddd;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
        }

        .file-box input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .actions {
            margin-top: 30px;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .report-paper {
            background: white;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .report-paper.active {
            display: block;
        }

        .report-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .report-logo {
            max-width: 100px;
            max-height: 100px;
        }

        .header-text h1 {
            color: #667eea;
            font-size: 28px;
        }

        .report-body {
            line-height: 1.8;
        }

        .declaration {
            margin: 20px 0;
            font-size: 16px;
        }

        .meta-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .clinical-section {
            margin: 20px 0;
        }

        .clinical-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .data-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .legal-box {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 4px solid #ffc107;
        }

        .signature-block {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .sign-img-container img {
            max-width: 200px;
            max-height: 80px;
        }

        .sign-text {
            text-align: right;
        }

        .timestamp {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        .report-actions {
            margin-top: 30px;
            text-align: center;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .report-actions {
                display: none !important;
            }

            .report-paper {
                box-shadow: none;
            }
        }
    </style>
</head>

<body>

    <main class="app-container">

        <!-- Header -->
        <header class="app-header">
            <div class="logo-area">
                <i class="ri-stethoscope-fill"></i>
                <span>MediRecord</span>
            </div>
            <h1>Teleconsultation Report</h1>
            <a href="/doctor/profile" class="btn-secondary">
                <i class="ri-arrow-left-line"></i> Back to Dashboard
            </a>
        </header>

        <!-- Form Section -->
        <section id="formSection" class="form-card animate-fade-in">

            <div class="form-header">
                <h2>Consultation Details</h2>
                <p>Fill in the details below to generate a medico-legal compliant record.</p>
            </div>

            <div class="grid-form">

                <!-- Doctor / Clinic Info -->
                <div class="group info-group">
                    <h3><i class="ri-hospital-line"></i> Medical Facility & Doctor</h3>

                    <div class="input-wrapper">
                        <label for="hospital">Hospital / Clinic Name</label>
                        <input type="text" id="hospital" value="<%= appointment ? appointment.Hospital : '' %>" placeholder="e.g. City General Hospital">
                    </div>

                    <div class="input-wrapper file-input-wrapper">
                        <label for="logo">Hospital Logo</label>
                        <div class="file-box">
                            <input type="file" id="logo" accept="image/*">
                            <span class="file-label"><i class="ri-upload-cloud-2-line"></i> Choose Image</span>
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <label for="doctor">Doctor Name</label>
                        <input type="text" id="doctor" value="Dr. <%= doctor ? doctor.name : '' %>" placeholder="Dr. Jane Doe">
                    </div>

                    <div class="input-wrapper">
                        <label for="qual">Qualification(s)</label>
                        <input type="text" id="qual" value="<%= doctor ? doctor.qualification : '' %>" placeholder="MBBS, MD (General Medicine)">
                    </div>

                    <div class="input-wrapper">
                        <label for="reg">Registration Number</label>
                        <input type="text" id="reg" value="<%= doctor ? doctor.regNo : '' %>" placeholder="MCI-123456">
                    </div>
                </div>

                <!-- Patient / Call Info -->
                <div class="group call-group">
                    <h3><i class="ri-user-heart-line"></i> Patient & Interaction</h3>

                    <div class="input-wrapper">
                        <label for="patient">Patient Name / ID</label>
                        <input type="text" id="patient" value="<%= appointment ? appointment.firstname + ' ' + appointment.lastname : '' %>" placeholder="John Smith / PID-992">
                    </div>

                    <div class="input-wrapper">
                        <label for="jurisdiction">Jurisdiction</label>
                        <select id="jurisdiction">
                            <option>India â€“ Telemedicine Practice Guidelines</option>
                            <option>Other (Specify in remarks)</option>
                        </select>
                    </div>

                    <div class="input-wrapper">
                        <label for="mode">Mode of Consultation</label>
                        <select id="mode">
                            <option <%= appointment && appointment.mode === 'online' ? 'selected' : '' %>>Video Consultation</option>
                            <option>Telephone</option>
                            <option>Telemedicine Platform</option>
                        </select>
                    </div>

                    <div class="row-2">
                        <div class="input-wrapper">
                            <label for="start">Call Start Time</label>
                            <input type="datetime-local" id="start">
                        </div>
                        <div class="input-wrapper">
                            <label for="end">Call End Time</label>
                            <input type="datetime-local" id="end">
                        </div>
                    </div>
                </div>

                <!-- Medical Data -->
                <div class="group medical-group wide">
                    <h3><i class="ri-clipboard-pulse-line"></i> Clinical Assessment</h3>

                    <div class="input-wrapper">
                        <label for="complaints">Clinical Complaints & History</label>
                        <textarea id="complaints" placeholder="Patient complains of..."><%= appointment ? appointment.Symptom : '' %></textarea>
                    </div>

                    <div class="input-wrapper">
                        <label for="diagnosis">Clinical Impression / Provisional Diagnosis</label>
                        <textarea id="diagnosis" placeholder="Viral Fever..."></textarea>
                    </div>

                    <div class="input-wrapper">
                        <label for="advice">Medical Advice / Treatment</label>
                        <textarea id="advice" placeholder="Rx: Paracetamol 500mg..."></textarea>
                    </div>

                    <div class="input-wrapper">
                        <label for="followup">Follow-up Plan</label>
                        <textarea id="followup" placeholder="Review after 3 days..."></textarea>
                    </div>
                </div>

                <!-- Signature -->
                <div class="group sign-group wide">
                    <h3><i class="ri-pen-nib-line"></i> Authorization</h3>
                    <div class="input-wrapper file-input-wrapper">
                        <label for="sign">Doctor Digital Signature</label>
                        <div class="file-box">
                            <input type="file" id="sign" accept="image/*">
                            <span class="file-label"><i class="ri-upload-cloud-2-line"></i> Upload Signature</span>
                        </div>
                    </div>
                </div>

            </div>

            <div class="actions">
                <button onclick="generate()" class="btn-primary">
                    <i class="ri-file-text-line"></i> Generate Report
                </button>
            </div>
        </section>


        <!-- REPORT PREVIEW (Hidden by default) -->
        <section id="report" class="report-paper">

            <header class="report-header">
                <img id="rLogo" class="report-logo" alt="Logo">
                <div class="header-text">
                    <h2 id="rHospital"></h2>
                    <h1>Medico-Legal Teleconsultation Record</h1>
                </div>
            </header>

            <div class="report-body">
                <p class="declaration">
                    I, <b><span id="rDoctor"></span></b>, holding qualification(s) <b><span id="rQual"></span></b>,
                    registered under <b><span id="rReg"></span></b>, hereby certify the following:
                </p>

                <div class="meta-box">
                    <p>
                        On <b><span id="rDate"></span></b>, I conducted a teleconsultation with <b><span
                                id="rPatient"></span></b> via <b><span id="rMode"></span></b>.
                    </p>
                    <p>
                        The interaction commenced at <b><span id="rStart"></span></b> and concluded at <b><span
                                id="rEnd"></span></b>,
                        with a total duration of <b><span id="rDuration"></span></b>.
                    </p>
                </div>

                <div class="clinical-section">
                    <h3>Clinical Summary</h3>
                    <div class="data-block" id="rComplaints"></div>
                </div>

                <div class="clinical-section">
                    <h3>Clinical Impression</h3>
                    <div class="data-block" id="rDiagnosis"></div>
                </div>

                <div class="clinical-section">
                    <h3>Medical Advice</h3>
                    <div class="data-block" id="rAdvice"></div>
                </div>

                <div class="clinical-section">
                    <h3>Follow-up & Escalation Plan</h3>
                    <div class="data-block" id="rFollowup"></div>
                </div>

                <div class="legal-box">
                    <h3>Legal Compliance Declaration</h3>
                    <p>
                        Explicit patient consent for teleconsultation was obtained prior to initiation.
                        This consultation was conducted in accordance with applicable telemedicine laws
                        and professional guidelines under the selected jurisdiction. The limitations of
                        teleconsultation were explained. The patient was advised to seek immediate
                        in-person or emergency care if clinical deterioration occurs.
                    </p>
                </div>

                <div class="signature-block">
                    <div class="sign-img-container">
                        <img id="rSign" alt="Signature">
                    </div>
                    <div class="sign-text">
                        <p><b><span id="rDoctor2"></span></b></p>
                        <p>Reg No: <span id="rReg2"></span></p>
                        <p class="timestamp">Generated: <span id="rTimestamp"></span></p>
                    </div>
                </div>
            </div>

            <!-- Buttons for the report view (hide in print) -->
            <div class="report-actions" data-html2canvas-ignore="true">
                <button onclick="saveReport()" class="btn-primary">
                    <i class="ri-save-line"></i> Save Report
                </button>
                <button onclick="window.print()" class="btn-primary">
                    <i class="ri-printer-line"></i> Print Report
                </button>
                <button onclick="editForm()" class="btn-secondary">
                    <i class="ri-edit-line"></i> Edit Details
                </button>
            </div>
        </section>

    </main>

    <script>
        function generate() {
            // Get form values
            const hospital = document.getElementById('hospital').value;
            const doctor = document.getElementById('doctor').value;
            const qual = document.getElementById('qual').value;
            const reg = document.getElementById('reg').value;
            const patient = document.getElementById('patient').value;
            const mode = document.getElementById('mode').value;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const complaints = document.getElementById('complaints').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const advice = document.getElementById('advice').value;
            const followup = document.getElementById('followup').value;

            // Handle logo
            const logoInput = document.getElementById('logo');
            if (logoInput.files && logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('rLogo').src = e.target.result;
                    document.getElementById('rLogo').style.display = 'block';
                }
                reader.readAsDataURL(logoInput.files[0]);
            }

            // Handle signature
            const signInput = document.getElementById('sign');
            if (signInput.files && signInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('rSign').src = e.target.result;
                }
                reader.readAsDataURL(signInput.files[0]);
            }

            // Calculate duration
            let duration = '';
            if (start && end) {
                const startTime = new Date(start);
                const endTime = new Date(end);
                const diff = Math.abs(endTime - startTime);
                const minutes = Math.floor(diff / 60000);
                duration = `${minutes} minutes`;
            }

            // Populate report
            document.getElementById('rHospital').textContent = hospital;
            document.getElementById('rDoctor').textContent = doctor;
            document.getElementById('rDoctor2').textContent = doctor;
            document.getElementById('rQual').textContent = qual;
            document.getElementById('rReg').textContent = reg;
            document.getElementById('rReg2').textContent = reg;
            document.getElementById('rPatient').textContent = patient;
            document.getElementById('rMode').textContent = mode;
            document.getElementById('rDate').textContent = new Date().toLocaleDateString('en-IN', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('rStart').textContent = start ? new Date(start).toLocaleString('en-IN') : '';
            document.getElementById('rEnd').textContent = end ? new Date(end).toLocaleString('en-IN') : '';
            document.getElementById('rDuration').textContent = duration;
            document.getElementById('rComplaints').textContent = complaints;
            document.getElementById('rDiagnosis').textContent = diagnosis;
            document.getElementById('rAdvice').textContent = advice;
            document.getElementById('rFollowup').textContent = followup;
            document.getElementById('rTimestamp').textContent = new Date().toLocaleString('en-IN');

            // Show report, hide form
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('report').classList.add('active');
        }

        function editForm() {
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('report').classList.remove('active');
        }

        async function saveReport() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const appointmentId = urlParams.get('appointmentId');
                
                if (!appointmentId) {
                    alert('No appointment ID found');
                    return;
                }

                // Get logo and signature as base64
                let logoUrl = '';
                let signatureUrl = '';
                
                const logoImg = document.getElementById('rLogo');
                if (logoImg && logoImg.src && !logoImg.src.includes('blob:')) {
                    logoUrl = logoImg.src;
                }
                
                const signImg = document.getElementById('rSign');
                if (signImg && signImg.src && !signImg.src.includes('blob:')) {
                    signatureUrl = signImg.src;
                }

                const reportData = {
                    appointmentId: appointmentId,
                    patientEmail: '<%= appointment ? appointment.email : "" %>',
                    hospital: document.getElementById('hospital').value,
                    logoUrl: logoUrl,
                    doctorName: document.getElementById('doctor').value,
                    qualification: document.getElementById('qual').value,
                    registrationNumber: document.getElementById('reg').value,
                    signatureUrl: signatureUrl,
                    jurisdiction: document.getElementById('jurisdiction').value,
                    consultationMode: document.getElementById('mode').value,
                    callStartTime: document.getElementById('start').value,
                    callEndTime: document.getElementById('end').value,
                    duration: document.getElementById('rDuration').textContent,
                    clinicalComplaints: document.getElementById('complaints').value,
                    clinicalImpression: document.getElementById('diagnosis').value,
                    medicalAdvice: document.getElementById('advice').value,
                    followupPlan: document.getElementById('followup').value
                };

                const response = await fetch('/doctor/save-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reportData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Report saved successfully!');
                    window.location.href = '/doctor/profile';
                } else {
                    alert('Failed to save report: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving report:', error);
                alert('Failed to save report. Please try again.');
            }
        }

        // File input labels
        document.getElementById('logo').addEventListener('change', function() {
            const fileName = this.files[0]?.name || 'Choose Image';
            this.nextElementSibling.innerHTML = `<i class="ri-check-line"></i> ${fileName}`;
        });

        document.getElementById('sign').addEventListener('change', function() {
            const fileName = this.files[0]?.name || 'Upload Signature';
            this.nextElementSibling.innerHTML = `<i class="ri-check-line"></i> ${fileName}`;
        });
    </script>
</body>

</html>
